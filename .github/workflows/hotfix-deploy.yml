name: ğŸ”¥ Hotfix Deploy

on:
  push:
    branches: [ hotfix/* ]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deployment target'
        required: true
        default: 'vercel'
        type: choice
        options:
        - vercel
        - netlify
        - github-pages
        - all

env:
  NODE_VERSION: '18'

jobs:
  emergency-deploy:
    name: ğŸš¨ Emergency Deployment
    runs-on: ubuntu-latest
    
    environment:
      name: emergency-hotfix
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“‹ Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build project
        run: npm run build
        env:
          CI: true
          
      - name: ğŸš€ Deploy to Vercel
        if: github.event.inputs.deploy_target == 'vercel' || github.event.inputs.deploy_target == 'all' || github.ref_type == 'branch'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./
          
      - name: ğŸŒ Deploy to Netlify
        if: github.event.inputs.deploy_target == 'netlify' || github.event.inputs.deploy_target == 'all' || github.ref_type == 'branch'
        uses: netlify/actions/cli@master
        with:
          args: deploy --prod --dir=portfolio/dist
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          
      - name: ğŸ“„ Deploy to GitHub Pages
        if: github.event.inputs.deploy_target == 'github-pages' || github.event.inputs.deploy_target == 'all' || github.ref_type == 'branch'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./portfolio/dist
          
      - name: ğŸ“¬ Notify emergency deployment
        uses: 8398a7/action-slack@v3
        if: always() && secrets.SLACK_WEBHOOK_URL != ''
        with:
          status: ${{ job.status }}
          channel: '#emergency'
          text: |
            ğŸš¨ **EMERGENCY HOTFIX DEPLOYMENT** ğŸš¨
            
            ğŸ“Š Status: ${{ job.status }}
            ğŸ¯ Target: ${{ github.event.inputs.deploy_target || 'all platforms' }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ‘¤ Triggered by: ${{ github.actor }}
            ğŸ“ Commit: ${{ github.sha }}
            
            ğŸ”— Repository: ${{ github.repository }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}